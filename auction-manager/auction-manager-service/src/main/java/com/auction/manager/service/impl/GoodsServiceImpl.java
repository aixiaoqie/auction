package com.auction.manager.service.impl;

import java.util.Date;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jms.core.JmsTemplate;
import org.springframework.transaction.annotation.Transactional;

import com.alibaba.dubbo.config.annotation.Service;
import com.alibaba.fastjson.JSON;
import com.auction.common.utils.AuctionResult;
import com.auction.common.utils.PageResult;
import com.auction.manager.service.GoodsService;
import com.auction.mapper.TbBrandMapper;
import com.auction.mapper.TbGoodsDescMapper;
import com.auction.mapper.TbGoodsMapper;
import com.auction.mapper.TbItemCatMapper;
import com.auction.mapper.TbItemMapper;
import com.auction.mapper.TbSellerMapper;
import com.auction.pojo.TbBrand;
import com.auction.pojo.TbGoods;
import com.auction.pojo.TbGoodsDesc;
import com.auction.pojo.TbGoodsExample;
import com.auction.pojo.TbGoodsExample.Criteria;
import com.auction.pojo.TbItem;
import com.auction.pojo.TbItemCat;
import com.auction.pojo.TbItemExample;
import com.auction.pojo.TbSeller;
import com.auction.vo.Goods;
import com.github.pagehelper.Page;
import com.github.pagehelper.PageHelper;

/**
 * 服务实现层
 * 
 * @author Administrator
 * 
 */
@Service
@Transactional
public class GoodsServiceImpl implements GoodsService {

	@Autowired
	private TbGoodsMapper goodsMapper;

	/**
	 * 查询全部
	 */
	@Override
	public List<TbGoods> findAll() {
		return goodsMapper.selectByExample(null);
	}

	/**
	 * 按分页查询
	 */
	@Override
	public PageResult findPage(int pageNum, int pageSize) {
		PageHelper.startPage(pageNum, pageSize);
		Page<TbGoods> page = (Page<TbGoods>) goodsMapper.selectByExample(null);
		return new PageResult(page.getTotal(), page.getResult());
	}

	// 注入货品描述mapper接口代理对象
	@Autowired
	private TbGoodsDescMapper goodsDescMapper;

	// 注入品牌mapper接口代理对象
	@Autowired
	private TbBrandMapper brandMapper;

	// 注入分类mapper接口代理对象
	@Autowired
	private TbItemCatMapper itemCatMapper;

	// 注入商品mapper接口代理对象
	@Autowired
	private TbItemMapper itemMapper;

	// 注入商家mapper接口代理对象
	@Autowired
	private TbSellerMapper sellerMapper;

	/**
	 * 增加 （卖家服务调用的接口方法）
	 */
	@Override
	public AuctionResult add(Goods goods) {

		try {
			// 保存货品表数据
			// 获取货品对象
			TbGoods tbGoods = goods.getGoods();
			// 保存货品,返回主键
			goodsMapper.insertSelective(tbGoods);
			// 再保存货品描述表
			// 获取货品描述对象
			TbGoodsDesc goodsDesc = goods.getGoodsDesc();
			// 设置外键
			goodsDesc.setGoodsId(tbGoods.getId());
			// 保存
			goodsDescMapper.insertSelective(goodsDesc);
			// 抽取保存方法
			saveItemList(goods.getItemList(), tbGoods, goodsDesc);

			// 保存成功
			return new AuctionResult(200, "保存成功");

		} catch (Exception e) {
			e.printStackTrace();
			return new AuctionResult(100, "保存失败");
		}

	}

	/**
	 * （卖家服务调用的接口方法） 保存商品数据
	 * 
	 * @param itemList
	 * @param tbGoods
	 * @param goodsDesc
	 */
	private void saveItemList(List<TbItem> itemList, TbGoods tbGoods, TbGoodsDesc goodsDesc) {
		// 通过货品获取品牌数据
		TbBrand brand = brandMapper.selectByPrimaryKey(tbGoods.getBrandId());

		// 查询分类对象
		TbItemCat itemCat = itemCatMapper.selectByPrimaryKey(tbGoods.getCategory3Id());

		// 查询店铺名称
		TbSeller seller = sellerMapper.findOneBySellerId(tbGoods.getSellerId());

		Map map1 = null;
		// 从商品描述对象中获取图片数据
		String itemImages = goodsDesc.getItemImages();
		// 判断描述对象中图片是否存在
		if (itemImages != null && !"".equals(itemImages)) {
			// [{"color":"白色","url":"http://192.168.25.133/group1/M00/00/00/wKgZhVmNXEWAWuHOAAjlKdWCzvg949.jpg"},{"color":"黑色","url":"http://192.168.25.133/group1/M00/00/00/wKgZhVmNXEuAB_ujAAETwD7A1Is158.jpg"},{"color":"蓝色","url":"http://192.168.25.133/group1/M00/00/00/wKgZhVmNXFWANtjTAAFa4hmtWek619.jpg"}]
			List<Map> images = JSON.parseArray(itemImages, Map.class);
			// 获取第一个对象
			map1 = images.get(0);
		}

		// 判断是否启用规格
		if ("1".equals(tbGoods.getIsEnableSpec())) {
			// 在保存商品sku列表
			// 获取商品sku列表对象
			// 循环sku列表对象
			for (TbItem item : itemList) {

				// 定义商品名称
				// 华为 移动4G,16G
				String skuName = "";

				// 从商品表中获取规格属性选项
				String spec = item.getSpec();
				// 把规格属性转换成map对象
				// 获取spec对象值
				// {spec:{"网络":"电信2G"}
				Map<String, Object> specMap = JSON.parseObject(spec);

				// 循环specmap对象
				for (String key : specMap.keySet()) {
					// 组合商品名称
					skuName += specMap.get(key);

				}
				// 设置货品相关属性值
				item.setGoodsId(tbGoods.getId());
				// 组合商品名称
				item.setTitle(tbGoods.getGoodsName() + skuName);

				item.setImage((String) map1.get("url"));

				// 保存品牌
				item.setBrand(brand.getName());

				//
				item.setCategory(itemCat.getName());
				// 分类id
				item.setCategoryid(itemCat.getId());
				// 设置买家id
				item.setSellerId(tbGoods.getSellerId());

				// 设置买家名称
				item.setSeller(seller.getNickName());

				// 设置时间
				Date date = new Date();
				item.setCreateTime(date);
				item.setUpdateTime(date);

				// 保存
				itemMapper.insertSelective(item);
			}

		} else {

			// 创建商品对象,保存商品数据
			TbItem item = new TbItem();

			item.setGoodsId(tbGoods.getId());
			// 设置商品标题
			item.setTitle(tbGoods.getGoodsName());
			//
			// 保存品牌
			item.setBrand(brand.getName());
			//
			item.setCategory(itemCat.getName());
			// 分类id
			item.setCategoryid(itemCat.getId());
			// 设置买家id
			item.setSellerId(tbGoods.getSellerId());
			// 设置买家名称
			item.setSeller(seller.getNickName());
			// 状态
			// 是否默认
			// 设置时间
			Date date = new Date();
			item.setCreateTime(date);
			item.setUpdateTime(date);

			// 保存
			itemMapper.insertSelective(item);

		}
	}

	/**
	 * 修改（卖家服务调用的接口方法）
	 */
	@Override
	public void update(Goods goods) {

		// 初始化商品状态
		goods.getGoods().setAuditStatus("0");
		// 修改商品对象
		goodsMapper.updateByPrimaryKey(goods.getGoods());
		// 修改商品描述对象
		goodsDescMapper.updateByPrimaryKey(goods.getGoodsDesc());

		// 1.先删除tb_item商品数据
		// 根据外键删除
		// 创建example对象
		TbItemExample example = new TbItemExample();
		// 创建criteria对象
		com.auction.pojo.TbItemExample.Criteria createCriteria = example.createCriteria();
		// 设置参数,根据外键删除
		createCriteria.andGoodsIdEqualTo(goods.getGoods().getId());

		// 删除操作
		itemMapper.deleteByExample(example);

		// 2.再新增tb_item商品数据
		// 获取商品列表
		List<TbItem> itemList = goods.getItemList();

		saveItemList(itemList, goods.getGoods(), goods.getGoodsDesc());

	}

	/**
	 * 根据ID获取实体
	 * 
	 * @param id
	 * @return
	 */
	@Override
	public Goods findOne(Long id) {
		// 创建包装类对象
		Goods goods = new Goods();
		// 查询商品对象
		TbGoods tbGoods = goodsMapper.selectByPrimaryKey(id);
		// 查询商品描述信息
		TbGoodsDesc tbGoodsDesc = goodsDescMapper.selectByPrimaryKey(tbGoods.getId());
		// 把商品对象设置包装类对象
		goods.setGoods(tbGoods);
		goods.setGoodsDesc(tbGoodsDesc);

		// 根据goodsid查询商品数据
		// 创建商品表example对象
		TbItemExample example = new TbItemExample();
		// 创建criteria对象
		com.auction.pojo.TbItemExample.Criteria createCriteria = example.createCriteria();
		// 设置查询参数
		createCriteria.andGoodsIdEqualTo(tbGoods.getId());

		// 执行查询
		List<TbItem> list = itemMapper.selectByExample(example);

		// 把商品集合设置包装类对象
		goods.setItemList(list);

		return goods;
	}

	// 注入消息发送模版
	@Autowired
	private JmsTemplate jmsTemplate;

	/**
	 * 批量删除
	 */
	@Override
	public void delete(String[] ids) {
		for (String id : ids) {
			// 根据id查询商品对象
			TbGoods tbGoods = goodsMapper.selectByPrimaryKey(Long.parseLong(id));
			tbGoods.setIsDelete("1");
			// 更新
			goodsMapper.updateByPrimaryKey(tbGoods);
		}
		// 发送消息
		jmsTemplate.convertAndSend(ids);
	}

	@Override
	public PageResult findPage(TbGoods goods, int pageNum, int pageSize) {
		PageHelper.startPage(pageNum, pageSize);
		TbGoodsExample example = new TbGoodsExample();
		Criteria criteria = example.createCriteria();

		if (goods != null) {
			if (goods.getSellerId() != null && goods.getSellerId().length() > 0) {
				criteria.andSellerIdEqualTo(goods.getSellerId());
			}
			if (goods.getGoodsName() != null && goods.getGoodsName().length() > 0) {
				criteria.andGoodsNameLike("%" + goods.getGoodsName() + "%");
			}
			if (goods.getAuditStatus() != null && goods.getAuditStatus().length() > 0) {
				criteria.andAuditStatusLike("%" + goods.getAuditStatus() + "%");
			}
			if (goods.getIsMarketable() != null && goods.getIsMarketable().length() > 0) {
				criteria.andIsMarketableLike("%" + goods.getIsMarketable() + "%");
			}
			if (goods.getCaption() != null && goods.getCaption().length() > 0) {
				criteria.andCaptionLike("%" + goods.getCaption() + "%");
			}
			if (goods.getSmallPic() != null && goods.getSmallPic().length() > 0) {
				criteria.andSmallPicLike("%" + goods.getSmallPic() + "%");
			}
			if (goods.getIsEnableSpec() != null && goods.getIsEnableSpec().length() > 0) {
				criteria.andIsEnableSpecLike("%" + goods.getIsEnableSpec() + "%");
			}
			if (goods.getIsDelete() != null && goods.getIsDelete().length() > 0) {
				criteria.andIsDeleteEqualTo(goods.getIsDelete());
			}
		}

		Page<TbGoods> page = (Page<TbGoods>) goodsMapper.selectByExample(example);
		return new PageResult(page.getTotal(), page.getResult());
	}

	/**
	 * 需求:更新商品状态.
	 * 
	 * @param ids
	 * @param status
	 * @return
	 */
	public AuctionResult updateGoodsStatus(String[] ids, String status) {
		try {
			// 循环数组ids
			for (String id : ids) {
				// 根据id把商品对象查询处理
				TbGoods tbGoods = goodsMapper.selectByPrimaryKey(Long.parseLong(id));
				// 修改状态
				tbGoods.setAuditStatus(status);
				// 修改
				goodsMapper.updateByPrimaryKeySelective(tbGoods);
			}
			// 传递消息 spu id
			jmsTemplate.convertAndSend(ids);
			// 修改成功
			return new AuctionResult(200, "修改成功");

		} catch (Exception e) {
			e.printStackTrace();
			return new AuctionResult(100, "修改失败");
		}
	}

}
